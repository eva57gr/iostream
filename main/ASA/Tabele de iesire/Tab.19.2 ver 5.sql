INSERT INTO CIS2.TABLE_OUT 
(
  PERIOADA,
  FORM,
  FORM_VERS,
  ID_MDTABLE,
  COD_CUATM,
  NR_SECTIE,
  NUME_SECTIE,
  NR_SECTIE1,
  NUME_SECTIE1,
  NR_SECTIE2,
  NUME_SECTIE2,
  NR_ROW,
  ORDINE,
  DECIMAL_POS,
  NUME_ROW,  
  COL1, COL2, COL3,COL4,COL5
)


SELECT 
:pPERIOADA AS PERIOADA,
  :pFORM AS FORM,
  :pFORM_VERS AS FORM_VERS,
  :pID_MDTABLE AS ID_MDTABLE,
  :pCOD_CUATM AS COD_CUATM,
  
  '0' AS NR_SECTIE,
  '0' AS NUME_SECTIE,
  '0' AS NR_SECTIE1,
  '0' AS NUME_SECTIE1,
  '0' AS NR_SECTIE2,
  '0' AS NUME_SECTIE2,
  CODUL_NEMOD||'~'|| ROWNUM AS NR_ROW,
  ROWNUM AS ORDINE,
 '00111' AS DECIMAL_POS,
CODUL||'  '||DENUMIRE  NUME_ROW,

CASE WHEN COL1 IS NULL THEN 0 ELSE COL1 END COL1,
CASE WHEN COL2 IS NULL THEN 0 ELSE COL2 END COL2,
CASE WHEN COL3 IS NULL THEN 0 ELSE COL3 END COL3,
CASE WHEN COL4 IS NULL THEN 0 ELSE COL4 END COL4,
CASE WHEN COL5 IS NULL THEN 0 ELSE COL5 END COL5
 
FROM  
(



SELECT 
2 ORDINE,
CC.FULL_CODE,
CC.DENUMIRE,
CC.CODUL CODUL_NEMOD,
CC.GRUPA,
CC.PRIM,

CASE  WHEN SUBSTR(CC.CODUL, -4) = '0000' THEN SUBSTR(CC.CODUL, 1, 1)
    ELSE CC.CODUL END CODUL, 
COUNT (DISTINCT DD.CUIIO) AS COL1,
ROUND(SUM(DD.COL1),0) AS COL2,
ROUND(SUM(DD.COL2),1) AS COL3,
ROUND(SUM(DD.COL3),1) AS COL4,
ROUND(SUM(DD.COL4),1) AS COL5

FROM
   (
SELECT 
 
 DISTINCT D.CUIIO, 
CASE WHEN MAX(CASE WHEN  D.RIND IN ('8') AND D.CAPITOL IN (1129) THEN D.COL31 END ) IS NULL 
 THEN    MAX(SUBSTR(D.CAEM2,2,4))  ELSE MAX(CASE WHEN  D.RIND IN ('8') AND D.CAPITOL IN (1129) THEN D.COL31 END ) END 
 
 AS CAEM2_ACTUALIZAT,
--
 MAX(SUBSTR(D.CAEM2,2,4))  AS CAEM2,
 

-- 
 
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (100)  AND D.RIND IN ('CD')  THEN  D.COL1 ELSE 0 END))  AS COL0,
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1127) AND D.RIND IN ('400') THEN  CIS2.NVAL(D.COL4) END))  AS COL1,
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1124) AND D.RIND IN ('150') THEN  CIS2.NVAL(D.COL1) END))  AS COL2,
  
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1124) AND D.RIND IN ('150','160','170') THEN  CIS2.NVAL(D.COL1) END))- 
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1125) AND D.RIND IN ('200') THEN CIS2.NVAL(D.COL1) END))+
(
 
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1126) AND D.RIND IN ('330') THEN CIS2.NVAL(D.COL2) - CIS2.NVAL(D.COL1) END))


 
 
 )+
 
(CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1126) AND D.RIND IN ('340') THEN CIS2.NVAL(D.COL2) END))-
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1126) AND D.RIND IN ('340') THEN CIS2.NVAL(D.COL1) END)))  AS COL3,
  
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1124) AND D.RIND IN ('150','160','170') THEN  CIS2.NVAL(D.COL1) END))- 
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1125) AND D.RIND IN ('200') THEN CIS2.NVAL(D.COL1) END))+
(CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1126) AND D.RIND IN ('330') THEN CIS2.NVAL(D.COL2) END))-
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1126) AND D.RIND IN ('330') THEN CIS2.NVAL(D.COL1) END)))+
 
(CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1126) AND D.RIND IN ('340') THEN CIS2.NVAL(D.COL2) END))-
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1126) AND D.RIND IN ('340') THEN CIS2.NVAL(D.COL1) END)))-
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1125) AND D.RIND IN ('220') THEN CIS2.NVAL(D.COL1) END))-
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1125) AND D.RIND IN ('240') THEN CIS2.NVAL(D.COL1) END))-
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1125) AND D.RIND IN ('290') THEN CIS2.NVAL(D.COL1) END))+
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1125) AND D.RIND IN ('294') THEN CIS2.NVAL(D.COL1) END))+
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (1124) AND D.RIND IN ('180') THEN CIS2.NVAL(D.COL1) END))   AS COL4,
 
 CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (100)  AND D.RIND IN ('CD') THEN  D.COL1 ELSE 0 END))  AS CD
 
FROM   
    CIS2.VW_DATA_ALL D       
WHERE
  D.FORM IN (64)             AND 
  D.FORM_VERS = :PFORM_VERS  AND      
  D.PERIOADA =:pPERIOADA AND
 -- D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%'   AND
 D.CAPITOL IN (100,1123,1124,1125,1126,1127,1128,1129) 
  
--AND  D.CUIIO=40856685
 GROUP BY 
 D.CUIIO
 
 
 HAVING
  CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (100)  AND D.RIND IN ('1','5') THEN  D.COL1 ELSE 0 END))  > 0
AND 
CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN (100)  AND D.RIND IN ('CD') THEN  D.COL1 ELSE 0 END)) >  0

 

 
 ) DD
 

  
  INNER JOIN (
 SELECT
CODUL, 
DENUMIRE, 
GRUPA, 
ORDINE, 
FULL_CODE, 
NUM_CODE, 
PRIM                
                FROM  CIS2.VW_CL_CAEM2
                
               
                
                WHERE 
                CODUL LIKE 'C%'
                OR CODUL LIKE 'B%'
                OR CODUL LIKE 'D%'
                OR CODUL LIKE 'E%'
                OR CODUL LIKE 'F%'
                OR CODUL LIKE 'G%'
                OR CODUL LIKE 'H%'
                OR CODUL LIKE 'I%'
                OR CODUL LIKE 'J%'
                OR CODUL LIKE 'L%'
                OR CODUL LIKE 'M%'
                OR CODUL LIKE 'N%'
                OR CODUL LIKE 'S%'
             
                
                
                ) C ON      SUBSTR( C.CODUL,2,4) = DD.CAEM2_ACTUALIZAT              
               INNER JOIN (
               
               SELECT 
CODUL, 
DENUMIRE, 
GRUPA, ORDINE,
FULL_CODE, 
NUM_CODE, PRIM

FROM CIS2.VW_CL_CAEM2

WHERE 
--CODUL LIKE 'C%'

--AND 

( SUBSTR(CODUL,1,3) --IN ('B05','B06','B07','B08','B09',
IN (
'B05','B06','B07','B08','B09',
'C10','C11','C12','C13','C14','C15','C16','C17','C18','C19','C20','C21','C22','C23','C24','C25','C26','C27','C28','C29','C30','C31','C32','C33',
'D35',
'E36','E37','E38','E39',
'F41','F42','F43',
'G45','G46','G47','G48',
'H49','H50','H51','H52','H53',
'I55','I56',
'J58','J59','J60','J61','J62','J63',
'M69','M70','M71','M72','M73','M74','M75',
'N77','N78','N79','N80','N81','N82',
'S94','S95','S96',
'L68'
) 

AND CODUL LIKE '%00') OR   CODUL IN ('B0000','B5000','B6000','B8000','B9000','C0000','D0000','E0000','F0000','G0000','H0000','I0000','J0000','L0000','M0000','N0000','S0000','00000')


               ) CC ON (C.FULL_CODE LIKE '%'||CC.CODUL||';%') 
               
               


--WHERE 
--1=1
--AND CC.PRIM IN ('1')
--
----AND  
----CC.CODUL LIKE 'E%'
--
----OR   CC.CODUL LIKE 'C0000%'
--
----AND CC.CODUL IN ('C0000','C1000','C1010','C1020')
----AND CC.GRUPA IN ('00000','C0000')
-- 
----AND CC.CODUL IN ('C3500','C3400','C3300','C3310','C3200','C3100','C3000','C2900','C2800','C2700','C2600','C2500','C2400','C2300','C2200','C2100','C2000','C1900','C1700','C1600','C1500','C1400','C1300','C1200','C2000','C1900'
----,'C1800','C1700','C1600','C1500','C1400','C1300','C1200','C1100','D3500','E3600','E3700','E3800','E3900','F4100','F4200','F4300','G4500','G4600','G4700','H4900','H5000','H5100','H5200','H5300',
----'I5500','I5600','J5800','J5900','J6000','J6100','J6200','J6300','M6900','M7000','M7100','M7200','M7300','M7400','M7500','M7500','N7700','N7800','N7900','N8000','N8100','N8200','S9500','S9600',
----'B0000','B5000','B6000','B8000','B9000','C0000','D0000','E0000','F0000','G0000','H0000','I0000','J0000','L0000','M0000','N0000','S0000','00000')
--
--OR  CC.CODUL IN ('B0000','B5000','B6000','B8000','B9000','C0000','D0000','E0000','F0000','G0000','H0000','I0000','J0000','L0000','M0000','N0000','S0000','00000')

   
   GROUP BY
CC.FULL_CODE,
CC.DENUMIRE,
CC.CODUL,
CC.GRUPA,
CC.PRIM
   
   ORDER BY 
   ORDINE,
   
   FULL_CODE
   
   )
   
   
  