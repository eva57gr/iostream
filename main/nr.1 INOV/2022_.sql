SELECT *
  
  FROM USER_BANCU.X_BAZA_SONDAJ_2022
  
  WHERE 
  
  CUIIO IN (
  SELECT
  DISTINCT CUIIO
--  SUM(COL1) AS COL1,
--  SUM(COL2) AS COL2, 
--  ROUND(SUM(COL2)/CIS2.NOZERO(SUM(COL1))*100,1) AS COL3  
 
 FROM
(
SELECT

  D.CUIIO,
  CIS2.NVAL(COUNT( DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('100.00','100.01','100.02','100.03','100.04','100.05','100.06','100.07')THEN D.CUIIO END )) AS COL1,
   
 CIS2.NVAL(MAX(CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1041.2.1.1','1041.2.1.2', '1042.3.1.1','1042.3.1.2','1042.3.1.3','1046.7.1.1','1046.7.1.2','1046.7.1.3','1047.8.1.1','1047.8.1.2','1047.8.1.3','1047.8.1.4') AND D.COL1=1 
  THEN D.COL1 ELSE NULL END)) AS COL2



  FROM 
  CIS2.VW_DATA_ALL D  
  
   
  
WHERE
  D.PERIOADA IN (:pPERIOADA) AND 
  D.FORM_VERS = :pFORM_VERS     AND   
  D.FORM= :pFORM     AND    
  (:pID_MDTABLE=:pID_MDTABLE) AND
  D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%' AND  
  D.FORM IN (48)  

  
GROUP BY  
  D.CUIIO
  )
  
  GROUP BY
  CUIIO
  
  
  HAVING 
  SUM(COL2)  > 0 
  
  
  )
  
  
  ;
  
  
  UPDATE USER_BANCU.X_BAZA_SONDAJ_2018
  
  SET ANUL = 2018;