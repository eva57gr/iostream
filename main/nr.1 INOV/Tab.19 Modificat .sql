INSERT INTO CIS2.TABLE_OUT 
(
  PERIOADA,
  FORM,
  FORM_VERS,
  ID_MDTABLE,
  COD_CUATM,
  NR_SECTIE,
  NUME_SECTIE,
  NR_SECTIE1,
  NUME_SECTIE1,
  NR_SECTIE2,
  NUME_SECTIE2,
  NR_ROW,
  ORDINE,
  DECIMAL_POS,
  NUME_ROW,  
  COL1,COL2, COL3
)
SELECT
  :pPERIOADA AS PERIOADA,
  :pFORM AS FORM,
  :pFORM_VERS AS FORM_VERS,
  :pID_MDTABLE AS ID_MDTABLE,
  :pCOD_CUATM AS COD_CUATM,
         
  '0' AS NR_SECTIE,
  '0' AS NUME_SECTIE,
  '0' AS NR_SECTIE1,
  '0' AS NUME_SECTIE1,
  '0' as NR_SECTIE2,
  '0' as NUME_SECTIE2,
  NR_ROW AS NR_ROW,
  ORDINE AS ORDINE,
  '000' AS DECIMAL_POS,
  NUME_ROW AS NUME_ROW ,
  SUM(COL1) AS COL1, 
  SUM(COL2) AS COL2, 
  SUM(COL3) AS COL3

--     
FROM
(
SELECT
  D.RIND AS NR_ROW,
  R.DENUMIRE AS NUME_ROW,
  D.CUIIO,
  R.ORDINE,
    
  
  CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN ('1045') AND D.COL1=1  THEN D.COL1 ELSE NULL END)) AS COL1,
  CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN ('1045') AND D.COL1=1  THEN D.COL2 ELSE NULL END)) AS COL2,
  CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN ('1045') AND D.COL1=1  THEN D.COL3 ELSE NULL END)) AS COL3

  
  FROM 
  CIS2.VW_DATA_ALL D  
  INNER JOIN CIS2.MD_RIND R ON D.RIND=R.RIND AND R.FORM=D.FORM AND R.CAPITOL=D.CAPITOL

  
WHERE
  D.PERIOADA IN (:pPERIOADA) AND 
  D.FORM_VERS = :pFORM_VERS     AND   
  D.FORM= :pFORM     AND    
  (:pID_MDTABLE=:pID_MDTABLE) AND
  D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%' AND  
  D.FORM IN (48)  AND D.CAPITOL IN (1045)
  AND D.RIND NOT IN ('6.1.1')
  
  
  AND D.CUIIO IN (
  
  
SELECT 
DISTINCT CUIIO
FROM  

(
SELECT
  TR.DENUMIRE,
  TR.ORDINE,
  D.CUIIO,
  COUNT(DISTINCT
    CASE 
      WHEN
        TR.CONDITIE IN ('BETWEEN') AND TR.CAEM2 LIKE '%'|| SUBSTR(D.CAEM2,0,1) ||'%' AND  D.PERS_IT BETWEEN (SUBSTR(TR.RESULT,0,INSTR(RESULT,'-')-1)) AND (SUBSTR(TR.RESULT,INSTR(TR.RESULT,'-')+1,LENGTH(TR.RESULT))) AND
        D.COL1 > 0
      THEN D.CUIIO
    END) AS COL1
  

FROM 
  (
    SELECT DISTINCT
      D.CUIIO,
      D.CAEM2,
      BS.PERS_IT,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1041.2.1.1','1041.2.1.2', '1042.3.1.1','1042.3.1.2','1042.3.1.3','1046.7.1.1','1046.7.1.2','1046.7.1.3','1047.8.1.1','1047.8.1.2','1047.8.1.3','1047.8.1.4') AND D.COL1=1 THEN 1 END) AS COL1,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1046.7.1.1','1046.7.1.2','1046.7.1.3','1047.8.1.1','1047.8.1.2','1047.8.1.3','1047.8.1.4') AND D.COL1=1 THEN 1 END) AS COL2_1,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1041.2.1.1','1041.2.1.2','1042.3.1.1','1042.3.1.2','1042.3.1.3') AND D.COL1=1 THEN 1 END) AS COL2_2,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1041.2.1.1','1041.2.1.2','1042.3.1.1','1042.3.1.2','1042.3.1.3') AND D.COL1=1 THEN 1 END) AS COL3_1,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1046.7.1.1','1046.7.1.2','1046.7.1.3','1047.8.1.1','1047.8.1.2','1047.8.1.3','1047.8.1.4') AND D.COL1=1 THEN 1 END) AS COL3_2,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1041.2.1.1','1041.2.1.2','1042.3.1.1','1042.3.1.2','1042.3.1.3') AND D.COL1=1 THEN 1 END) AS COL4_1,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1046.7.1.1','1046.7.1.2','1046.7.1.3','1047.8.1.1','1047.8.1.2','1047.8.1.3','1047.8.1.4') AND D.COL1=1 THEN 1 END) AS COL4_2
    FROM
      CIS2.VW_DATA_ALL D  
      INNER JOIN
      CIS2.X_BAZA_SONDAJ BS ON D.CUIIO=BS.CUIIO AND D.ANUL=BS.ANUL
    WHERE
      D.PERIOADA IN (:pPERIOADA) AND 
      D.FORM_VERS = :pFORM_VERS     AND   
      D.FORM= :pFORM     AND    
      (:pID_MDTABLE=:pID_MDTABLE) AND
      D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%'  AND 
      D.FORM IN (48)
    GROUP BY
      D.CUIIO,
      D.CAEM2,
      BS.PERS_IT
  ) D
CROSS JOIN
 (

SELECT '10-49 salariati' AS DENUMIRE, 2 AS ORDINE, 'BETWEEN' AS CONDITIE, 'B+C+D+E+G46+H+J+K+M71+M72+M73' AS CAEM2, '0-49' AS RESULT FROM DUAL UNION 
SELECT '50-249 salariati' AS DENUMIRE, 3 AS ORDINE, 'BETWEEN' AS CONDITIE, 'B+C+D+E+G46+H+J+K+M71+M72+M73' AS CAEM2, '50-249' AS RESULT FROM DUAL  

) TR
GROUP BY
  TR.DENUMIRE,
  TR.ORDINE,
  D.CUIIO
  
  
  HAVING 
  
    COUNT(DISTINCT
    CASE 
      WHEN
        TR.CONDITIE IN ('BETWEEN') AND TR.CAEM2 LIKE '%'|| SUBSTR(D.CAEM2,0,1) ||'%' AND  D.PERS_IT BETWEEN (SUBSTR(TR.RESULT,0,INSTR(RESULT,'-')-1)) AND (SUBSTR(TR.RESULT,INSTR(TR.RESULT,'-')+1,LENGTH(TR.RESULT))) AND
        D.COL1 > 0
      THEN D.CUIIO
    END) <> 0
    
     )
  )




  
GROUP BY  
  D.RIND,
  R.DENUMIRE,
  D.CUIIO,
  R.ORDINE
  )
  
  
  GROUP BY
  NR_ROW,
  NUME_ROW,
  ORDINE
  
  
  
  
   
   UNION
   
   SELECT
  :pPERIOADA AS PERIOADA,
  :pFORM AS FORM,
  :pFORM_VERS AS FORM_VERS,
  :pID_MDTABLE AS ID_MDTABLE,
  :pCOD_CUATM AS COD_CUATM,
         
  '0' AS NR_SECTIE,
  '0' AS NUME_SECTIE,
  '0' AS NR_SECTIE1,
  '0' AS NUME_SECTIE1,
  '0' as NR_SECTIE2,
  '0' as NUME_SECTIE2,
  NR_ROW AS NR_ROW,
  ORDINE AS ORDINE,
  '000' AS DECIMAL_POS,
  NUME_ROW AS NUME_ROW ,
  SUM(COL1) AS COL1, 
  SUM(COL2) AS COL2, 
  SUM(COL3) AS COL3

--     
FROM
(
SELECT
  '1' AS NR_ROW,
  'Total' AS NUME_ROW,  
  1 as ORDINE,
    
  
  CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN ('1045') AND D.COL1=1  THEN D.COL1 ELSE NULL END)) AS COL1,
  CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN ('1045') AND D.COL1=1  THEN D.COL2 ELSE NULL END)) AS COL2,
  CIS2.NVAL(SUM(CASE WHEN D.CAPITOL IN ('1045') AND D.COL1=1  THEN D.COL3 ELSE NULL END)) AS COL3

  
  FROM 
  CIS2.VW_DATA_ALL D  
  INNER JOIN CIS2.MD_RIND R ON D.RIND=R.RIND AND R.FORM=D.FORM AND R.CAPITOL=D.CAPITOL

  
WHERE
  D.PERIOADA IN (:pPERIOADA) AND 
  D.FORM_VERS = :pFORM_VERS     AND   
  D.FORM= :pFORM     AND    
  (:pID_MDTABLE=:pID_MDTABLE) AND
  D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%' AND  
  D.FORM IN (48)  AND D.CAPITOL IN (1045)
  AND D.RIND NOT IN ('6.1.1')
  
  AND D.CUIIO IN (
  
  
SELECT 
DISTINCT CUIIO
FROM  

(
SELECT
  TR.DENUMIRE,
  TR.ORDINE,
  D.CUIIO,
  COUNT(DISTINCT
    CASE 
      WHEN
        TR.CONDITIE IN ('BETWEEN') AND TR.CAEM2 LIKE '%'|| SUBSTR(D.CAEM2,0,1) ||'%' AND  D.PERS_IT BETWEEN (SUBSTR(TR.RESULT,0,INSTR(RESULT,'-')-1)) AND (SUBSTR(TR.RESULT,INSTR(TR.RESULT,'-')+1,LENGTH(TR.RESULT))) AND
        D.COL1 > 0
      THEN D.CUIIO
    END) AS COL1
  

FROM 
  (
    SELECT DISTINCT
      D.CUIIO,
      D.CAEM2,
      BS.PERS_IT,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1041.2.1.1','1041.2.1.2', '1042.3.1.1','1042.3.1.2','1042.3.1.3','1046.7.1.1','1046.7.1.2','1046.7.1.3','1047.8.1.1','1047.8.1.2','1047.8.1.3','1047.8.1.4') AND D.COL1=1 THEN 1 END) AS COL1,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1046.7.1.1','1046.7.1.2','1046.7.1.3','1047.8.1.1','1047.8.1.2','1047.8.1.3','1047.8.1.4') AND D.COL1=1 THEN 1 END) AS COL2_1,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1041.2.1.1','1041.2.1.2','1042.3.1.1','1042.3.1.2','1042.3.1.3') AND D.COL1=1 THEN 1 END) AS COL2_2,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1041.2.1.1','1041.2.1.2','1042.3.1.1','1042.3.1.2','1042.3.1.3') AND D.COL1=1 THEN 1 END) AS COL3_1,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1046.7.1.1','1046.7.1.2','1046.7.1.3','1047.8.1.1','1047.8.1.2','1047.8.1.3','1047.8.1.4') AND D.COL1=1 THEN 1 END) AS COL3_2,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1041.2.1.1','1041.2.1.2','1042.3.1.1','1042.3.1.2','1042.3.1.3') AND D.COL1=1 THEN 1 END) AS COL4_1,
      COUNT(DISTINCT CASE WHEN D.CAPITOL||'.'||D.RIND IN ('1046.7.1.1','1046.7.1.2','1046.7.1.3','1047.8.1.1','1047.8.1.2','1047.8.1.3','1047.8.1.4') AND D.COL1=1 THEN 1 END) AS COL4_2
    FROM
      CIS2.VW_DATA_ALL D  
      INNER JOIN
      CIS2.X_BAZA_SONDAJ BS ON D.CUIIO=BS.CUIIO AND D.ANUL=BS.ANUL
    WHERE
      D.PERIOADA IN (:pPERIOADA) AND 
      D.FORM_VERS = :pFORM_VERS     AND   
      D.FORM= :pFORM     AND    
      (:pID_MDTABLE=:pID_MDTABLE) AND
      D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%'  AND 
      D.FORM IN (48)
    GROUP BY
      D.CUIIO,
      D.CAEM2,
      BS.PERS_IT
  ) D
CROSS JOIN
 (

SELECT '10-49 salariati' AS DENUMIRE, 2 AS ORDINE, 'BETWEEN' AS CONDITIE, 'B+C+D+E+G46+H+J+K+M71+M72+M73' AS CAEM2, '0-49' AS RESULT FROM DUAL UNION 
SELECT '50-249 salariati' AS DENUMIRE, 3 AS ORDINE, 'BETWEEN' AS CONDITIE, 'B+C+D+E+G46+H+J+K+M71+M72+M73' AS CAEM2, '50-249' AS RESULT FROM DUAL  

) TR
GROUP BY
  TR.DENUMIRE,
  TR.ORDINE,
  D.CUIIO
  
  
  HAVING 
  
    COUNT(DISTINCT
    CASE 
      WHEN
        TR.CONDITIE IN ('BETWEEN') AND TR.CAEM2 LIKE '%'|| SUBSTR(D.CAEM2,0,1) ||'%' AND  D.PERS_IT BETWEEN (SUBSTR(TR.RESULT,0,INSTR(RESULT,'-')-1)) AND (SUBSTR(TR.RESULT,INSTR(TR.RESULT,'-')+1,LENGTH(TR.RESULT))) AND
        D.COL1 > 0
      THEN D.CUIIO
    END) <> 0
    
     )
  )


  )
  
  
  GROUP BY
  NR_ROW,
  NUME_ROW,
  ORDINE
  
  ORDER BY 
   NR_ROW