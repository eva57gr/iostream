---- 4.1 --
--BEGIN
--
--INSERT INTO cis.TABLE_OUT 
--(
--  PERIOADA,
--  FORM,
--  FORM_VERS,
--  ID_MDTABLE,
--  COD_CUATM,
--  NR_SECTIE,
--  NUME_SECTIE,
--  NR_SECTIE1,
--  NUME_SECTIE1,
--  NR_SECTIE2,
--  NUME_SECTIE2,
--  NR_ROW,
--  ORDINE,
--  DECIMAL_POS,
--  NUME_ROW,
--  
--  COL1, COL2, COL3, COL4, COL5, COL6
--)

SELECT
  :pPERIOADA AS PERIOADA,
  :pFORM AS FORM,
  :pFORM_VERS AS FORM_VERS,
  :pID_MDTABLE AS ID_MDTABLE,
  :pCOD_CUATM AS COD_CUATM,
  '0' AS NR_SECTIE,
  '0' AS NUME_SECTIE,
  '0' AS NR_SECTIE1,
  '0' AS NUME_SECTIE1,
  '0' AS NR_SECTIE2,
  '0' AS NUME_SECTIE2,
  CASE WHEN R.CUIIO IN (-1) THEN R.CODUL                WHEN R.CUIIO NOT IN (-1) THEN '~'||TO_CHAR(ROWNUM)  END AS NR_ROW,
  ROWNUM AS ORDINE,
  '111111' AS DECIMAL_POS,
  CASE WHEN R.CUIIO IN (-1) THEN R.DENUMIRE||' -'||R.UM WHEN R.CUIIO NOT IN (-1) THEN '.....'||R.DEN END AS NUME_ROW,
  R.COL1,R.COL2,R.COL3,R.COL4,R.COL5,R.COL6

FROM
(
  SELECT 
    CUIIO,
    CODUL,
    MAX(DENUMIRE) AS DENUMIRE,
    MAX(UM) AS UM,
    MAX(DEN) AS DEN,
    SUM(COL1) AS COL1,
    SUM(COL2) AS COL2,
    SUM(COL3) AS COL3,
    SUM(COL4) AS COL4,
    SUM(COL5) AS COL5,
    SUM(COL6) AS COL6,
    SUM(CTRL_CNT) AS CTRL_CNT,
    SUM(CTRL_SUM) AS CTRL_SUM
    
  FROM
  (
--PROD CODES 

    SELECT
      C.CODUL, C.DENUMIRE, C.UM, -1 AS CUIIO, '' AS DEN, C.FULL_CODE,
      SUM(CASE WHEN D.PERIOADA = :pPERIOADA THEN D.COL2 END) AS COL1,
      
      SUM(CASE WHEN D.PERIOADA =:pPERIOADA-12 THEN D.COL2 END) AS COL2,
      
      SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN D.COL2 END) AS COL3,
      
      SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN D.COL2 END) AS COL4,
      
      100*SUM(CASE WHEN D.PERIOADA = :pPERIOADA THEN D.COL2 END)/
      CIS.NOZERO(SUM(CASE WHEN D.PERIOADA = :pPERIOADA-12 THEN D.COL2 END)) AS COL5,
      
      100*SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN D.COL2 END)/
      CIS.NOZERO(SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN D.COL2  END)) AS COL6,
      
      SUM(CASE WHEN D.PERIOADA = :pPERIOADA  THEN 1          ELSE NULL END) AS CTRL_CNT, 
      MAX(CASE WHEN D.PERIOADA = :pPERIOADA  THEN CIS.NVAL(COL2) ELSE NULL END) / CIS.NOZERO(
      SUM(CASE WHEN D.PERIOADA = :pPERIOADA  THEN CIS.NVAL(COL2) ELSE NULL END)) * 100 AS CTRL_SUM

    FROM CIS.VW_DATA_ALL_CALC D
      INNER JOIN CIS.VW_CL_PRODMOLD2 C ON(C.CODUL = SUBSTR(D.RIND,1,LENGTH(D.RIND)-2))
      INNER JOIN CIS.RENIM R ON (D.CUIIO = R.CUIIO AND D.CUIIO_VERS = R.CUIIO_VERS)
      INNER JOIN CIS.VW_CL_CUATM VC ON (D.CUATM = VC.CODUL)
--------------------------------------
    WHERE
      VC.FULL_CODE LIKE '%'||:pCOD_CUATM||';%' AND
       --D.PERIOADA IN (
       (D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 OR 
       D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA) AND
      
      D.FORM = :pFORM AND
      D.FORM_VERS = :pFORM_VERS AND       
      D.CAPITOL IN(94)

    GROUP BY 
      C.CODUL, C.DENUMIRE, C.UM, C.FULL_CODE

    HAVING
      CIS.NVAL(SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN D.COL2 END))<>0 
      OR
      CIS.NVAL(SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN D.COL2 END))<>0

    UNION
--PROD CODES(SUBTOTAL)

    SELECT
      CP.CODUL, CP.DENUMIRE||' (TOTAL)', CP.UM, -1 AS CUIIO, '' AS DEN, CP.FULL_CODE,
      SUM(CASE WHEN D.PERIOADA = :pPERIOADA THEN D.COL2 END) AS COL1,
      SUM(CASE WHEN D.PERIOADA = :pPERIOADA-12 THEN D.COL2 END) AS COL2,
      
      SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN D.COL2 END) AS COL3,
            
      SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN D.COL2 END) AS COL4,
      
      100*SUM(CASE WHEN D.PERIOADA = :pPERIOADA THEN D.COL2 END)/
      CIS.NOZERO(SUM(CASE WHEN D.PERIOADA = :pPERIOADA-12 THEN D.COL2 END)) AS COL5,
      
      100*SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN D.COL2 END)/
      CIS.NOZERO(SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN D.COL2  END)) AS COL6,
      
      SUM(CASE WHEN D.PERIOADA = :pPERIOADA  THEN 1          ELSE NULL END) AS CTRL_CNT, 
      MAX(CASE WHEN D.PERIOADA = :pPERIOADA  THEN CIS.NVAL(COL2) ELSE NULL END) / CIS.NOZERO(
      SUM(CASE WHEN D.PERIOADA = :pPERIOADA  THEN CIS.NVAL(COL2) ELSE NULL END)) * 100 AS CTRL_SUM

    FROM CIS.VW_DATA_ALL_CALC D
       INNER JOIN CIS.VW_CL_PRODMOLD2 C ON(C.CODUL = SUBSTR(D.RIND,1,LENGTH(D.RIND)-2) AND
                                   D.FORM IN (3) AND
                                  -- D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA AND
                                   (LENGTH(D.RIND)-2) = 9)
        INNER JOIN
        (
            SELECT
               CODUL,DENUMIRE,UM,FULL_CODE,PROD_TYPE      
            FROM
               CIS.VW_CL_PRODMOLD2
            WHERE
                PROD_TYPE = 'SUBT' 
        ) CP ON(C.FULL_CODE LIKE '%'||CP.CODUL||';%')
      INNER JOIN CIS.RENIM R ON (D.CUIIO = R.CUIIO AND D.CUIIO_VERS = R.CUIIO_VERS)
      INNER JOIN CIS.VW_CL_CUATM VC ON (D.CUATM = VC.CODUL)

    WHERE
      VC.FULL_CODE LIKE '%'||:pCOD_CUATM||';%' AND 
      
      (D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA OR
      D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12) AND
      
      D.FORM = :pFORM AND
      D.FORM_VERS = :pFORM_VERS AND       
      D.CAPITOL IN(94) AND
      CP.PROD_TYPE = 'SUBT'

    GROUP BY 
      CP.CODUL, CP.DENUMIRE, CP.UM, CP.FULL_CODE

    HAVING
      CIS.NVAL(SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR(:pPERIOADA/12)*12 AND :pPERIOADA THEN D.COL2 END))<>0 
      OR
      CIS.NVAL(SUM(CASE WHEN D.PERIOADA BETWEEN FLOOR((:pPERIOADA-12)/12)*12 AND :pPERIOADA-12 THEN D.COL2 END))<>0

)
  GROUP BY 
    CODUL, CUIIO
  ORDER BY 
    CODUL, CUIIO

) R;

--WHERE
--    R.CTRL_CNT > 3 OR (R.CTRL_CNT = 3 AND R.CTRL_SUM <= 85);
    
--END;