--INSERT INTO TABLE_OUT 
--(
--  PERIOADA,
--  FORM,
--  FORM_VERS,
--  ID_MDTABLE,
--  COD_CUATM,
--  NR_SECTIE,
--  NUME_SECTIE,
--  NR_SECTIE1,
--  NUME_SECTIE1,
--  NR_SECTIE2,
--  NUME_SECTIE2,
--  NR_ROW,
--  ORDINE,
--  DECIMAL_POS,
--  NUME_ROW,  
-- COL1,
--  COL2,
--  COL3,
--  COL4,
--  COL5,
--  COL6,
--  COL7,
--  COL8,
--  COL9,
--  COL10,
--  COL11,
--  COL12,
--  COL13,
--  COL14,
--  COL15
--)

SELECT
  :PPERIOADA AS PERIOADA,
  :PFORM AS FORM,
  :PFORM_VERS AS FORM_VERS,
  :PID_MDTABLE AS ID_MDTABLE,
  :PCOD_CUATM AS COD_CUATM,
  '0' AS NR_SECTIE,
  '0' AS NUME_SECTIE,
  '0' AS NR_SECTIE1,
  '0' AS NUME_SECTIE1,
  '0' AS NR_SECTIE2,
  '0' AS NUME_SECTIE2,
   D.CODUL AS NR_ROW,
   ROWNUM AS ORDINE,
  '111111111111111' AS DECIMAL_POS,
  D.DENUMIRE  AS NUME_ROW,
  ROUND(D.COL1,1) AS COL1,
  ROUND(D.COL2,1) AS COL2,
  ROUND(D.COL3,1) AS COL3,
  ROUND(D.COL4,1) AS COL4,
  ROUND(D.COL5,1) AS COL5,
  ROUND(D.COL6,1) AS COL6,
  ROUND(D.COL7,1) AS COL7,
  ROUND(D.COL8,1) AS COL8,
  ROUND(D.COL9,1) AS COL9,
  ROUND(D.COL10,1) AS COL10,
  ROUND(D.COL11,1) AS COL11,
  ROUND(D.COL12,1) AS COL12,
  ROUND(D.COL13,1) AS COL13,
  ROUND(D.COL14,1) AS COL14,
  ROUND(D.COL15,1) AS COL15

FROM 
(
SELECT
  CODUL,
  DENUMIRE,
  FULL_CODE,
  COL1,
  COL2,
  COL3,
  COL4,
  COL5,
  COL6,
  COL7,
  COL8,
  COL9,
  COL10,
  COL11,
  COL12,
  COL13,
  COL14,
  COL15
FROM
(
SELECT
   CC.CODUL,
   CC.DENUMIRE,
   CC.FULL_CODE,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('01') THEN D.COL1 ELSE NULL END)) AS COL1,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('02') THEN D.COL1 ELSE NULL END)) AS COL2,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('03') THEN D.COL1 ELSE NULL END)) AS COL3,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('04') THEN D.COL1 ELSE NULL END)) AS COL4,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('05') THEN D.COL1 ELSE NULL END)) AS COL5,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('06') THEN D.COL1 ELSE NULL END)) AS COL6,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('07') THEN D.COL1 ELSE NULL END)) AS COL7,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('08') THEN D.COL1 ELSE NULL END)) AS COL8,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('09') THEN D.COL1 ELSE NULL END)) AS COL9,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('01') THEN D.COL1 ELSE NULL END)) AS COL10,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('02') THEN D.COL1 ELSE NULL END)) AS COL11,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('03') THEN D.COL1 ELSE NULL END)) AS COL12,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('04') THEN D.COL1 ELSE NULL END)) AS COL13,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('05') THEN D.COL1 ELSE NULL END)) AS COL14,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('06') THEN D.COL1 ELSE NULL END)) AS COL15
FROM
  VW_DATA_ALL D
  INNER JOIN VW_CL_CUATM C ON C.CODUL = D.CUATM
  INNER JOIN VW_CL_CUATM CC ON C.FULL_CODE LIKE '%'||CC.CODUL||';%'
WHERE
  D.FORM IN (65) AND 
  D.FORM_VERS = :pFORM_VERS AND
  D.PERIOADA IN (:pPERIOADA) AND     
  D.CAPITOL IN (1130,1131) AND
  D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%' 
  AND (CC.PRGS IN ('2','3','5') AND CC.CODUL NOT IN ('0101000'))
  
 -- AND D.CUIIO = 4500415
  
GROUP BY 
  CC.CODUL,
  CC.DENUMIRE,
  CC.FULL_CODE
--ORDER BY
--  CC.FULL_CODE
UNION ALL
SELECT
   '0101000' AS CODUL,
   'OR.CHISINAU' AS DENUMIRE,
   '0000000;0100000;0101000;' AS FULL_CODE,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('01') THEN D.COL1 ELSE NULL END)) AS COL1,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('02') THEN D.COL1 ELSE NULL END)) AS COL2,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('03') THEN D.COL1 ELSE NULL END)) AS COL3,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('04') THEN D.COL1 ELSE NULL END)) AS COL4,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('05') THEN D.COL1 ELSE NULL END)) AS COL5,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('06') THEN D.COL1 ELSE NULL END)) AS COL6,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('07') THEN D.COL1 ELSE NULL END)) AS COL7,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('08') THEN D.COL1 ELSE NULL END)) AS COL8,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1130) AND D.RIND IN ('09') THEN D.COL1 ELSE NULL END)) AS COL9,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('01') THEN D.COL1 ELSE NULL END)) AS COL10,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('02') THEN D.COL1 ELSE NULL END)) AS COL11,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('03') THEN D.COL1 ELSE NULL END)) AS COL12,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('04') THEN D.COL1 ELSE NULL END)) AS COL13,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('05') THEN D.COL1 ELSE NULL END)) AS COL14,
   NVAL(SUM(CASE WHEN D.CAPITOL IN (1131) AND D.RIND IN ('06') THEN D.COL1 ELSE NULL END)) AS COL15
FROM
  VW_DATA_ALL D
  INNER JOIN VW_CL_CUATM C ON C.CODUL = D.CUATM
--  INNER JOIN VW_CL_CUATM CC ON C.FULL_CODE LIKE '%'||CC.CODUL||';%'
WHERE
  D.FORM IN (65) AND 
  D.FORM_VERS = :pFORM_VERS AND
  D.PERIOADA IN (:pPERIOADA) AND     
  D.CAPITOL IN (1130,1131) AND
  D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%' 
  AND (C.PRGS IN ('4'))
  
  AND D.CUIIO = 4500415
)
ORDER BY
  FULL_CODE
) D