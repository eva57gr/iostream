
SELECT

D.CUIIO,
--D.IDNO,
--D.DENUMIRE,
--D.CUATM,
--D.RIND,
SUM(D.COL1) AS COL1 

FROM

(
SELECT

D.CUIIO,
D.IDNO,
D.DENUMIRE,
D.CUATM,
D.RIND,
D.COL1 
FROM

(
SELECT 
D.CUIIO,
R.IDNO,
R.DENUMIRE,
D.CUATM,
D.RIND,
SUM(D.COL1) AS COL1 

FROM CIS2.VW_DATA_ALL D 
        INNER JOIN CIS2.RENIM R ON R.CUIIO = D.CUIIO AND R.CUIIO_VERS = D.CUIIO_VERS 

        

WHERE
  D.PERIOADA IN (:pPERIOADA) AND 
  D.FORM_VERS = :pFORM_VERS     AND    
  (:pID_MDTABLE=:pID_MDTABLE) AND
  D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%' AND
  D.FORM IN (45)                
  AND D.RIND IN ('1440')
  
  --AND D.CUIIO  LIKE '%'||41070998||'%' 
  
GROUP BY 
D.CUIIO,
R.IDNO,
R.DENUMIRE,
D.CUATM,
D.RIND


HAVING 

D.CUIIO IN (
 SELECT 
 L.CUIIO   
  
 FROM  USER_BANCU.VW_KATALOG_29_AGRO_1059  L
 
        LEFT JOIN USER_BANCU.VW_KATALOG_RSF1_2012 R ON R.CUIIO = L.CUIIO
        
        WHERE
         R.CUIIO IS NOT  NULL  
         
         
      )
      
      
      UNION ALL 
      
      SELECT
D.CUIIO,
R.IDNO,
R.DENUMIRE,
R.CUATM,
'1400' RIND,
SUM(D.COL1) AS COL1 


FROM 

(

SELECT
D.CUIIO,
D.CUATM,
D.NEW_CUIIO AS NEW_CUIIO,
SUM(D.COL1) AS COL1


FROM 

(
SELECT
D.CUIIO,
D.CUATM,
CASE
WHEN
SUBSTR(TO_CHAR(D.CUIIO), -2) = SUBSTR(TO_CHAR(D.CUATM), 1,2) 
AND D.CUIIO NOT IN (
40283431,
40840796,
40964957,
4153405087,
3921883,
41173362,
3398889431,
4150180887,
41263036,
3397681089,
4107097160,
41558748,
41124412,
41172248,
41582853,
40672117,
4590096645,
4062117845,
4865978,
381760601,
3400052936,
41266974,
3464444012,
41583545,
960309551138,
3786196178,
41190627,
41392845,
1023604000914,
41322592634,
41002117,
41154471)

THEN
SUBSTR(TO_CHAR(D.CUIIO), 1, LENGTH(TO_CHAR(D.CUIIO)) - 2)

WHEN
SUBSTR(TO_CHAR(D.CUIIO), -4) = SUBSTR(TO_CHAR(D.CUATM), 1,4)
AND  LENGTH(D.CUIIO) = 12 AND  
D.CUIIO NOT IN (
40283431,
40840796,
40964957,
4153405087,
3921883,
41173362,
3398889431,
4150180887,
41263036,
3397681089,
4107097160,
41558748,
41124412,
41172248,
41582853,
40672117,
4590096645,
4062117845,
4865978,
381760601,
3400052936,
41266974,
3464444012,
41583545,
960309551138,
3786196178,
41190627,
41392845,
1023604000914,
41322592634,
41002117,
41154471)

 THEN
SUBSTR(TO_CHAR(D.CUIIO), 1, LENGTH(TO_CHAR(D.CUIIO)) - 4) 

ELSE 

TO_CHAR(D.CUIIO)  END  AS NEW_CUIIO,
D.RIND,
SUM(D.COL1) AS COL1

FROM CIS2.VW_DATA_ALL D
        INNER JOIN CIS2.RENIM R ON R.CUIIO = D.CUIIO AND R.CUIIO_VERS = D.CUIIO_VERS

WHERE
  D.PERIOADA IN (:pPERIOADA) AND
  D.FORM_VERS = :pFORM_VERS     AND
  (:pID_MDTABLE=:pID_MDTABLE) AND
  D.CUATM_FULL LIKE '%'||:pCOD_CUATM||';%' AND
  D.FORM IN (45)
  AND D.RIND IN ('1440')

   --AND D.CUIIO  LIKE '%'||41070998||'%' 

 ---  AND D.CUIIO = 4114834143
--  AND D.CUIIO = 410709989601

--AND D.NEW_CUIIO  = 41070998


GROUP BY
D.CUIIO,
--D.CUIIO_VERS,
D.CUATM,
D.RIND

HAVING

D.CUIIO IN (
 SELECT 
 L.CUIIO   
  
 FROM  USER_BANCU.VW_KATALOG_29_AGRO_1059  L
 
        LEFT JOIN USER_BANCU.VW_KATALOG_RSF1_2012 R ON R.CUIIO = L.CUIIO
        
        WHERE
         R.CUIIO IS   NULL  
         
         
       

)

) D






GROUP BY 
D.CUIIO,
D.CUATM,
D.NEW_CUIIO 

) D



  LEFT JOIN USER_BANCU.VW_MAX_RENIM_TRIM_CIS2 R ON R.CUIIO = D.CUIIO

GROUP BY

D.CUIIO,
R.CUATM,
R.IDNO,
R.DENUMIRE

) D



GROUP BY 

D.CUIIO,
D.IDNO,
D.DENUMIRE,
D.CUATM,
D.RIND,
D.COL1 

HAVING 

D.CUIIO IN (41070998,410709989601)

ORDER BY
D.CUIIO DESC

)
D


           -- LEFT JOIN   USER_BANCU.VW_MAX_RENIM_TRIM_CIS2 DD ON (D.CUIIO = DD.CUIIO)
            




--WHERE 
--TO_CHAR(D.CUIIO) LIKE '%'||TO_CHAR(D.CUIIO)||'%'

GROUP BY 
D.CUIIO,
D.CUATM









