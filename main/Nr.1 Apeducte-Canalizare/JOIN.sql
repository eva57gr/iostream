
SELECT 

L.CUIIO 
FROM

(

SELECT 
CUIIO,
COUNT (CUIIO) AS CNT, 
RIND,
SUM(CAP1_1_COL1) AS COL1
FROM
(
SELECT
  D.CUIIO,
  D.RIND,
  ROUND(SUM(CASE WHEN D.CAPITOL IN (1034) THEN D.COL1 ELSE 0 END),1) AS CAP1_1_COL1

 
  

    FROM CIS2.VW_DATA_ALL D 
    
            INNER JOIN CIS2.VW_CL_CUATM C ON C.CODUL = D.CUATM
            INNER JOIN CIS2.RENIM R ON R.CUIIO = D.CUIIO AND R.CUIIO_VERS = D.CUIIO_VERS 
    
    WHERE 
    
    D.PERIOADA IN (:pPERIOADA)
    AND D.FORM IN (:pFORM)    
    AND D.CAPITOL IN (1034)
    AND D.RIND IN ('0000000')

  GROUP BY 

  D.CUIIO,

  D.RIND


)


GROUP BY 
CUIIO,
RIND


HAVING 

COUNT (CUIIO) = 1  

ORDER BY 
CUIIO ) L LEFT JOIN (

SELECT 
CUIIO,
COUNT (CUIIO) AS CNT, 
SUM(COL1) AS COL1
FROM 

(
SELECT
D.CUIIO,
D.RIND,

  CIS2.NVAL(SUM(CASE WHEN CAPITOL IN (1034) AND D.RIND  NOT  IN '0000000' THEN COL1 ELSE 0 END)) AS COL1

  
FROM
  CIS2.VW_DATA_ALL D
 INNER JOIN CIS2.VW_CL_CUATM C ON (D.RIND=C.CODUL )
  
WHERE
  (D.PERIOADA=:pPERIOADA) AND
  (D.FORM=:pFORM) AND
  (D.FORM_VERS=:pFORM_VERS) AND
  (:pID_MDTABLE=:pID_MDTABLE) AND
   D.FORM = 47 AND
  -- D.CUIIO=3399698 AND
   D.CAPITOL IN (1034,1035) 
   
   --AND CC.PRGS NOT IN 4  AND
   AND C.FULL_CODE LIKE '%'||:pCOD_CUATM||'%'
   
GROUP BY 

--  C.CODUL, C.FULL_CODE,C.PRGS,
  D.CUIIO,
  D.RIND
--   ORDER BY 
--   C.FULL_CODE

)

GROUP BY 
CUIIO

ORDER BY 
CUIIO

) R ON L.CUIIO = R.CUIIO 

WHERE 
R.CUIIO IS NULL 